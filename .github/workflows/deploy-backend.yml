name: Deploy Backend to AWS EC2

on:
  push:
    branches: [main]
    paths:
      - 'apps/simulation-api/**'
      - 'libs/core/**'
      - 'pnpm-workspace.yaml'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to AWS EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/terrainsim-key.pem
          chmod 600 ~/.ssh/terrainsim-key.pem
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        run: |
          ssh -i ~/.ssh/terrainsim-key.pem ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            set -e

            echo "ðŸ“¦ Pulling latest changes..."
            cd ${{ secrets.SERVER_DEPLOY_PATH }}
            git fetch origin
            git reset --hard origin/main

            echo "ðŸ“š Installing dependencies..."
            pnpm install --frozen-lockfile

            echo "ðŸ”¨ Building C++ native addon..."
            cd libs/core/bindings/node
            npm install
            npm run build

            echo "ðŸ”„ Restarting application..."
            cd ${{ secrets.SERVER_DEPLOY_PATH }}
            pm2 restart terrainsim-api || pm2 start ecosystem.config.js

            echo "âœ… Deployment complete!"
            pm2 status
          ENDSSH

      - name: Health check
        run: |
          echo "ðŸ¥ Waiting for server to start..."
          sleep 10

          echo "ðŸ” Checking health endpoint..."
          curl -f https://api.lmvcruz.work/health || exit 1

          echo "âœ… Server is healthy!"

      - name: Notify deployment
        if: success()
        run: |
          echo "âœ… Backend deployed successfully!"
          echo "ðŸŒ API URL: https://api.lmvcruz.work"
