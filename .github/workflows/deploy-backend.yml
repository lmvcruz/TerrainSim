name: Deploy Backend to Production

on:
  workflow_dispatch:
    inputs:
      rebuild:
        description: 'Rebuild C++ addon?'
        required: true
        default: 'none'
        type: choice
        options:
          - none
          - incremental
          - full

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to AWS EC2

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run pre-deployment security scan
        run: |
          chmod +x scripts/pre-deploy-scan.sh
          ./scripts/pre-deploy-scan.sh --report-file pre-deploy-scan-report.txt

      - name: Upload scan report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pre-deploy-scan-report
          path: pre-deploy-scan-report.txt
          retention-days: 30

      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add Server to Known Hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H 54.242.131.12 >> ~/.ssh/known_hosts

      - name: Deploy - Pull Latest Code
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@54.242.131.12 '
            cd /var/www/terrainsim
            echo "ğŸ“¥ Pulling latest code from main branch..."

            # Stash any local changes to prevent merge conflicts
            if ! git diff-index --quiet HEAD --; then
              echo "âš ï¸  Local changes detected, stashing..."
              git stash
            fi

            git pull origin main

            echo "ğŸ“¦ Installing/updating dependencies..."
            pnpm install

            echo "ğŸ” Verifying tsx installation..."
            if [ ! -f "node_modules/.bin/tsx" ]; then
              echo "âŒ tsx binary not found, installing directly..."
              cd apps/simulation-api
              pnpm add tsx
              cd ../..
            fi

            echo "âœ… tsx location: $(which tsx || echo node_modules/.bin/tsx)"
          '

      - name: Deploy - Rebuild C++ Addon (Incremental)
        if: ${{ inputs.rebuild == 'incremental' }}
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@54.242.131.12 '
            cd /var/www/terrainsim/libs/core
            echo "ğŸ”¨ Rebuilding C++ addon (incremental)..."
            cmake --build build --config Release
          '

      - name: Deploy - Rebuild C++ Addon (Full Clean Build)
        if: ${{ inputs.rebuild == 'full' }}
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@54.242.131.12 '
            cd /var/www/terrainsim/libs/core
            echo "ğŸ”¨ Rebuilding C++ addon (full clean build)..."
            rm -rf build
            cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
            cmake --build build --config Release
          '

      - name: Deploy - Configure Nginx Body Size
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@54.242.131.12 '
            echo "âš™ï¸  Configuring nginx body size limit..."

            # Find nginx config file for api.lmvcruz.work (search all files, not just .conf)
            NGINX_CONFIG=$(sudo grep -rl "server_name.*api.lmvcruz.work" /etc/nginx/sites-available/ /etc/nginx/conf.d/ 2>/dev/null | head -1)

            if [ -z "$NGINX_CONFIG" ]; then
              echo "âŒ Could not find nginx config for api.lmvcruz.work"
              echo "Available nginx configs:"
              sudo ls -la /etc/nginx/sites-available/ /etc/nginx/conf.d/ 2>/dev/null || true
              echo "Searching all nginx files for api.lmvcruz.work..."
              sudo grep -r "api.lmvcruz.work" /etc/nginx/ || true
              exit 1
            fi

            echo "Found nginx config: $NGINX_CONFIG"

            # Check if client_max_body_size is already set
            if ! sudo grep -q "client_max_body_size" "$NGINX_CONFIG"; then
              echo "Adding client_max_body_size to nginx config..."
              # Add to http or server block
              if sudo grep -q "server_name.*api.lmvcruz.work" "$NGINX_CONFIG"; then
                sudo sed -i "/server_name.*api.lmvcruz.work/a \    client_max_body_size 20M;" "$NGINX_CONFIG"
              else
                # Add to the first server block
                sudo sed -i "/server {/a \    client_max_body_size 20M;" "$NGINX_CONFIG"
              fi

              # Test nginx configuration
              if sudo nginx -t; then
                echo "âœ… Nginx config valid, reloading..."
                sudo systemctl reload nginx
                echo "âœ… Nginx configured to accept up to 20MB request bodies"
              else
                echo "âŒ Nginx config test failed!"
                sudo cat "$NGINX_CONFIG"
                exit 1
              fi
            else
              echo "âœ… Body size limit already configured"
            fi
          '

      - name: Deploy - Restart PM2
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@54.242.131.12 '
            cd /var/www/terrainsim
            echo "ğŸ”„ Stopping PM2 process..."
            pm2 delete terrainsim-api || true

            echo "ğŸš€ Starting PM2 with ecosystem config..."
            pm2 start ecosystem.config.cjs
            pm2 save
          '

      - name: Wait for PM2 Restart
        run: |
          echo "â³ Waiting 10 seconds for PM2 to restart..."
          sleep 10

      - name: Health Check
        run: |
          echo "ğŸ¥ Running health check (30 attempts, 60 seconds timeout)..."
          for i in {1..30}; do
            if curl -f -s https://api.lmvcruz.work/health > /dev/null 2>&1; then
              echo "âœ… Health check passed!"
              echo "ğŸ‰ Deployment successful!"
              exit 0
            fi
            echo "â³ Attempt $i/30 - Service not ready yet..."
            sleep 2
          done
          echo "âŒ Health check failed after 60 seconds"
          echo "ğŸš¨ Deployment failed - service did not respond"
          exit 1

      - name: Show PM2 Logs on Failure
        if: failure()
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@54.242.131.12 '
            echo "ğŸ“‹ PM2 Status:"
            pm2 status
            echo ""
            echo "ğŸ“‹ PM2 Error Logs (last 50 lines):"
            pm2 logs terrainsim-api --err --lines 50 --nostream
            echo ""
            echo "ğŸ“‹ PM2 Output Logs (last 50 lines):"
            pm2 logs terrainsim-api --out --lines 50 --nostream
          '

      - name: Deployment Summary
        if: success()
        run: |
          echo "ğŸ“Š Deployment Summary:"
          echo "  - Repository: ${{ github.repository }}"
          echo "  - Branch: ${{ github.ref_name }}"
          echo "  - Commit: ${{ github.sha }}"
          echo "  - Rebuild: ${{ inputs.rebuild }}"
          echo "  - Server: 54.242.131.12"
          echo "  - Health: https://api.lmvcruz.work/health"
          echo ""
          echo "âœ… Backend is live and healthy!"
